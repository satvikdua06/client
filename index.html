<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Sync Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .room-setup {
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .player-section {
            display: none;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .player-section.active {
            display: grid;
        }

        .main-player {
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .current-song {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .current-song h3 {
            color: #feca57;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .music-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: none;
            letter-spacing: 0;
        }

        .tab-button.active {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input-group input {
            flex: 1;
            margin: 0;
        }

        .search-input-group button {
            padding: 15px 20px;
            min-width: auto;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
        }

        .search-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .search-item img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .search-item-info {
            flex: 1;
        }

        .search-item-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #feca57;
        }

        .search-item-artist {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .search-item-duration {
            font-size: 0.8em;
            opacity: 0.6;
        }

        .video-input input {
            width: 100%;
            margin-bottom: 15px;
        }

        .youtube-player {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            margin-bottom: 25px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .youtube-player iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .audio-player {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }

        .audio-player audio {
            width: 100%;
            margin-top: 15px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .controls button {
            min-width: 120px;
        }

        .room-info {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .room-id {
            font-size: 1.5em;
            font-weight: bold;
            color: #48dbfb;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .users-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .user-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            height: 250px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 14px;
        }

        .chat-message .username {
            font-weight: bold;
            color: #feca57;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 10px 20px;
            font-size: 14px;
            min-width: auto;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        .disconnected {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .no-results {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .player-section {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            input[type="text"] {
                min-width: auto;
            }
            
            .search-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        🔴 Disconnected
    </div>

    <div class="container">
        <div class="header">
            <h1>🎵 Sync Music Player</h1>
            <p>Listen to music together, perfectly in sync!</p>
        </div>

        <div class="card room-setup" id="roomSetup">
            <h2>🚪 Join or Create a Room</h2>
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="Your name" maxlength="20">
                <input type="text" id="roomIdInput" placeholder="Room ID (leave empty to create new)" maxlength="20">
                <button onclick="joinRoom()">Join Room</button>
            </div>
            <div class="status" id="setupStatus">
                Enter your name and room ID to get started! 🎶
            </div>
        </div>

        <div class="player-section" id="playerSection">
            <div class="main-player">
                <div class="card current-song" id="currentSong">
                    <h3>🎵 No song selected</h3>
                    <p>Search for music or add a YouTube video to start listening together!</p>
                </div>

                <div class="card">
                    <div class="music-tabs">
                        <button class="tab-button active" onclick="switchTab('search')">🔍 Search Music</button>
                        <button class="tab-button" onclick="switchTab('youtube')">📺 YouTube</button>
                    </div>

                    <div class="tab-content active" id="searchTab">
                        <div class="search-section">
                            <div class="search-input-group">
                                <input type="text" id="searchQuery" placeholder="Search for songs, artists, albums...">
                                <button onclick="searchMusic()">🔍</button>
                            </div>
                            <div class="search-results" id="searchResults">
                                <div class="no-results">Enter a search term to find music 🎵</div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="youtubeTab">
                        <div class="video-input">
                            <input type="text" id="youtubeUrl" placeholder="Paste YouTube URL here...">
                            <button onclick="loadVideo()">🎬 Load Video</button>
                        </div>
                    </div>
                </div>

                <div id="playerContainer">
                    <div class="youtube-player" style="display: none;" id="youtubePlayerContainer">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(255,255,255,0.1); border-radius: 15px;">
                            <p style="font-size: 1.2em; opacity: 0.7;">🎬 Video player will appear here</p>
                        </div>
                    </div>
                    
                    <div class="audio-player" style="display: none;" id="audioPlayerContainer">
                        <h4 id="audioTrackTitle">🎵 Audio Player</h4>
                        <audio controls id="audioPlayer">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>

                <div class="controls">
                    <button onclick="playPause()" id="playPauseBtn">▶️ Play</button>
                    <button onclick="syncRequest()">🔄 Sync</button>
                </div>

                <div class="card">
                    <div class="status" id="playerStatus">Ready to play music! 🎶</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="card room-info">
                    <h3>🏠 Room Info</h3>
                    <div class="room-id" id="currentRoomId">-</div>
                    <div><strong id="userCount">0 users online</strong></div>
                    <div class="users-list" id="usersList">
                        <!-- Users will be listed here -->
                    </div>
                </div>

                <div class="card chat-section">
                    <h3>💬 Chat</h3>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">
                            <span class="username">System:</span> Welcome to the chat!
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message..." maxlength="200">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Update this with your actual server URL
        const SERVER_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'https://your-server-url.onrender.com'; // Replace with your actual server URL

        // Remove mock socket references
        let player;
        let isPlayerReady = false;
        let socket;
        let currentRoomId = null;
        let username = null;
        let isUpdatingFromRemote = false;
        let userList = [];
        let currentTrackType = null; // 'youtube' or 'audio'
        let audioPlayer = null;

        // Initialize everything when page loads
        window.addEventListener('load', () => {
            loadYouTubeAPI();
            initSocket();
            initAudioPlayer();
        });

        // Load YouTube API
        function loadYouTubeAPI() {
            if (window.YT) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // YouTube API ready callback
        function onYouTubeIframeAPIReady() {
            console.log('✅ YouTube API loaded');
        }

        // Enhanced audio player initialization
        function initAudioPlayer() {
            audioPlayer = document.getElementById('audioPlayer');
            
            audioPlayer.addEventListener('loadstart', () => {
                updateStatus('⏳ Loading audio...');
            });
            
            audioPlayer.addEventListener('canplay', () => {
                updateStatus('🎵 Audio ready!');
            });
            
            audioPlayer.addEventListener('play', () => {
                if (!isUpdatingFromRemote && currentTrackType === 'audio') {
                    socket.emit('play-pause', {
                        isPlaying: true,
                        currentTime: audioPlayer.currentTime,
                        mediaType: 'audio'
                    });
                    updatePlayPauseButton(true);
                    updateStatus('▶️ Playing...');
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
                if (!isUpdatingFromRemote && currentTrackType === 'audio') {
                    socket.emit('play-pause', {
                        isPlaying: false,
                        currentTime: audioPlayer.currentTime,
                        mediaType: 'audio'
                    });
                    updatePlayPauseButton(false);
                    updateStatus('⏸️ Paused');
                }
            });
            
            audioPlayer.addEventListener('seeked', () => {
                if (!isUpdatingFromRemote && currentTrackType === 'audio') {
                    socket.emit('seek', {
                        currentTime: audioPlayer.currentTime,
                        isPlaying: !audioPlayer.paused,
                        mediaType: 'audio'
                    });
                }
            });
            
            audioPlayer.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                updateStatus('❌ Audio playback error');
            });
            
            audioPlayer.addEventListener('ended', () => {
                updateStatus('✅ Audio ended');
                updatePlayPauseButton(false);
            });
        }

        // Initialize Socket connection
        function initSocket() {
            // Use real socket connection instead of mock
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                timeout: 20000,
                forceNew: true
            });

            socket.on('connect', () => {
                console.log('✅ Connected to server');
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                console.log('❌ Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('connect_error', (error) => {
                console.warn('Connection error:', error);
                updateConnectionStatus(false);
                // Auto-reconnect logic
                setTimeout(() => {
                    if (!socket.connected) {
                        socket.connect();
                    }
                }, 5000);
            });

            socket.on('room-state', (state) => {
                console.log('📦 Received room state:', state);
                if (state.currentMedia) {
                    if (state.mediaType === 'youtube') {
                        createPlayer(state.currentMedia.videoId);
                        updateCurrentSong(state.currentMedia.title);
                        // Set player to correct state after it's ready
                        setTimeout(() => {
                            if (player && isPlayerReady) {
                                isUpdatingFromRemote = true;
                                player.seekTo(state.currentTime, true);
                                if (state.isPlaying) {
                                    player.playVideo();
                                    updatePlayPauseButton(true);
                                } else {
                                    player.pauseVideo();
                                    updatePlayPauseButton(false);
                                }
                                setTimeout(() => { isUpdatingFromRemote = false; }, 500);
                            }
                        }, 1000);
                    } else if (state.mediaType === 'audio') {
                        playTrack(state.currentMedia);
                        setTimeout(() => {
                            if (audioPlayer) {
                                isUpdatingFromRemote = true;
                                audioPlayer.currentTime = state.currentTime;
                                if (state.isPlaying) {
                                    audioPlayer.play();
                                    updatePlayPauseButton(true);
                                } else {
                                    audioPlayer.pause();
                                    updatePlayPauseButton(false);
                                }
                                setTimeout(() => { isUpdatingFromRemote = false; }, 500);
                            }
                        }, 500);
                    }
                }
                document.getElementById('currentRoomId').textContent = state.roomId || currentRoomId;
            });

            socket.on('video-change', (videoData) => {
                console.log('🎬 Video changed:', videoData);
                currentTrackType = 'youtube';
                document.getElementById('audioPlayerContainer').style.display = 'none';
                document.getElementById('youtubePlayerContainer').style.display = 'block';
                createPlayer(videoData.videoId);
                updateCurrentSong(videoData.title);
                updateStatus(`🎵 ${videoData.title} loaded!`);
            });

            socket.on('audio-change', (audioData) => {
                console.log('🎵 Audio changed:', audioData);
                playTrack(audioData);
                updateStatus(`🎵 ${audioData.title} - ${audioData.artist} loaded!`);
            });

            socket.on('play-pause', (data) => {
                console.log('⏯️ Remote play/pause:', data);
                if (isUpdatingFromRemote) return;
                
                isUpdatingFromRemote = true;
                
                if (data.mediaType === 'youtube' && player && isPlayerReady) {
                    player.seekTo(data.currentTime, true);
                    if (data.isPlaying) {
                        player.playVideo();
                        updatePlayPauseButton(true);
                    } else {
                        player.pauseVideo();
                        updatePlayPauseButton(false);
                    }
                } else if (data.mediaType === 'audio' && audioPlayer) {
                    audioPlayer.currentTime = data.currentTime;
                    if (data.isPlaying) {
                        audioPlayer.play().catch(e => console.warn('Audio play failed:', e));
                        updatePlayPauseButton(true);
                    } else {
                        audioPlayer.pause();
                        updatePlayPauseButton(false);
                    }
                }
                
                setTimeout(() => { isUpdatingFromRemote = false; }, 200);
            });

            socket.on('seek', (data) => {
                console.log('⏭️ Remote seek:', data);
                if (isUpdatingFromRemote) return;
                
                isUpdatingFromRemote = true;
                
                if (data.mediaType === 'youtube' && player && isPlayerReady) {
                    player.seekTo(data.currentTime, true);
                    if (data.isPlaying) {
                        player.playVideo();
                        updatePlayPauseButton(true);
                    }
                } else if (data.mediaType === 'audio' && audioPlayer) {
                    audioPlayer.currentTime = data.currentTime;
                    if (data.isPlaying) {
                        audioPlayer.play().catch(e => console.warn('Audio play failed:', e));
                        updatePlayPauseButton(true);
                    }
                }
                
                setTimeout(() => { isUpdatingFromRemote = false; }, 200);
            });

            socket.on('sync-response', (syncData) => {
                console.log('🔄 Sync response:', syncData);
                if (isUpdatingFromRemote) return;
                
                isUpdatingFromRemote = true;
                
                if (syncData.mediaType === 'youtube' && player && isPlayerReady) {
                    const currentTime = player.getCurrentTime();
                    const timeDiff = Math.abs(currentTime - syncData.currentTime);
                    
                    // Only sync if time difference is significant (more than 2 seconds)
                    if (timeDiff > 2) {
                        player.seekTo(syncData.currentTime, true);
                    }
                    
                    if (syncData.isPlaying) {
                        player.playVideo();
                        updatePlayPauseButton(true);
                    } else {
                        player.pauseVideo();
                        updatePlayPauseButton(false);
                    }
                } else if (syncData.mediaType === 'audio' && audioPlayer) {
                    const currentTime = audioPlayer.currentTime;
                    const timeDiff = Math.abs(currentTime - syncData.currentTime);
                    
                    // Only sync if time difference is significant
                    if (timeDiff > 2) {
                        audioPlayer.currentTime = syncData.currentTime;
                    }
                    
                    if (syncData.isPlaying) {
                        audioPlayer.play().catch(e => console.warn('Audio play failed:', e));
                        updatePlayPauseButton(true);
                    } else {
                        audioPlayer.pause();
                        updatePlayPauseButton(false);
                    }
                }
                
                updateStatus('✅ Synced with room!');
                setTimeout(() => { isUpdatingFromRemote = false; }, 500);
            });

            socket.on('user-joined', (userName) => {
                updateStatus(`👋 ${userName} joined the room`);
                addChatMessage('System', `${userName} joined the room`);
            });

            socket.on('user-left', (userName) => {
                updateStatus(`👋 ${userName} left the room`);
                addChatMessage('System', `${userName} left the room`);
            });

            socket.on('user-list', (users) => {
                userList = users;
                updateUsersList();
                document.getElementById('userCount').textContent = `${users.length} user${users.length !== 1 ? 's' : ''} online`;
            });

            socket.on('chat-message', (data) => {
                addChatMessage(data.username, data.message);
            });
        }

        // Search music using multiple APIs
        async function searchMusic() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                updateStatus('❌ Please enter a search term');
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">🔍 Searching for music...</div>';

            try {
                // Try multiple free music APIs
                let results = [];
                
                // 1. Try iTunes API
                try {
                    const itunesResults = await searchItunes(query);
                    results = results.concat(itunesResults);
                } catch (e) {
                    console.warn('iTunes API failed:', e);
                }
                
                // 2. Try Deezer API
                try {
                    const deezerResults = await searchDeezer(query);
                    results = results.concat(deezerResults);
                } catch (e) {
                    console.warn('Deezer API failed:', e);
                }
                
                // 3. Try JioSaavn API
                try {
                    const jiosaavnResults = await searchJioSaavn(query);
                    results = results.concat(jiosaavnResults);
                } catch (e) {
                    console.warn('JioSaavn API failed:', e);
                }

                // 4. Try AudioMack API (mock)
                try {
                    const mockResults = await searchMockAPI(query);
                    results = results.concat(mockResults);
                } catch (e) {
                    console.warn('Mock API failed:', e);
                }

                displaySearchResults(results.slice(0, 20)); // Limit to 20 results
                
            } catch (error) {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = '<div class="no-results">❌ Search failed. Please try again.</div>';
            }
        }

        // Search iTunes API
        async function searchItunes(query) {
            const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=10`);
            const data = await response.json();
            
            return data.results.map(item => ({
                id: `itunes_${item.trackId}`,
                title: item.trackName,
                artist: item.artistName,
                album: item.collectionName,
                duration: Math.floor(item.trackTimeMillis / 1000),
                preview_url: item.previewUrl,
                artwork: item.artworkUrl100,
                source: 'iTunes'
            })).filter(item => item.preview_url);
        }

        // Search JioSaavn API
        async function searchJioSaavn(query) {
            try {
                // Using JioSaavn's unofficial API
                const response = await fetch(`https://www.jiosaavn.com/api.php?__call=autocomplete.get&_format=json&_marker=0&cc=in&includeMetaTags=1&query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                let results = [];
                
                // If we get song results, fetch detailed info
                if (data.songs && data.songs.data) {
                    const songResults = await Promise.all(
                        data.songs.data.slice(0, 5).map(async (song) => {
                            try {
                                const detailResponse = await fetch(`https://www.jiosaavn.com/api.php?__call=song.getDetails&cc=in&_marker=0&_format=json&pids=${song.id}`);
                                const detailData = await detailResponse.json();
                                
                                if (detailData && detailData[song.id]) {
                                    const track = detailData[song.id];
                                    return {
                                        id: `jiosaavn_${track.id}`,
                                        title: track.song,
                                        artist: track.primary_artists,
                                        album: track.album,
                                        duration: parseInt(track.duration),
                                        preview_url: track.media_preview_url || track.media_url,
                                        artwork: track.image ? track.image.replace('150x150', '300x300') : null,
                                        source: 'JioSaavn'
                                    };
                                }
                            } catch (e) {
                                console.warn('Error fetching JioSaavn song details:', e);
                                return null;
                            }
                        })
                    );
                    
                    results = results.concat(songResults.filter(Boolean));
                }
                
                return results;
                
            } catch (error) {
                console.warn('JioSaavn search error:', error);
                // Fallback to mock JioSaavn data
                return [
                    {
                        id: `jiosaavn_mock_${Date.now()}`,
                        title: `${query} - Bollywood Hit`,
                        artist: 'Popular Artist',
                        album: 'Latest Album',
                        duration: 215,
                        preview_url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                        artwork: 'https://via.placeholder.com/300x300/ff6b6b/ffffff?text=🎵',
                        source: 'JioSaavn'
                    },
                    {
                        id: `jiosaavn_mock2_${Date.now()}`,
                        title: `${query} - Regional Hit`,
                        artist: 'Regional Star',
                        album: 'Folk Collection',
                        duration: 195,
                        preview_url: 'https://www.soundjay.com/misc/sounds/beep-07a.wav',
                        artwork: 'https://via.placeholder.com/300x300/48dbfb/ffffff?text=🎶',
                        source: 'JioSaavn'
                    }
                ];
            }
        }

        // Mock API for demonstration
        async function searchMockAPI(query) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const mockTracks = [
                {
                    id: 'mock_1',
                    title: `${query} - Demo Track 1`,
                    artist: 'Demo Artist',
                    album: 'Demo Album',
                    duration: 180,
                    preview_url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    artwork: 'https://via.placeholder.com/100x100/ff6b6b/ffffff?text=🎵',
                    source: 'Free Music'
                },
                {
                    id: 'mock_2',
                    title: `${query} - Sample Song`,
                    artist: 'Sample Band',
                    album: 'Sample Collection',
                    duration: 240,
                    preview_url: 'https://www.soundjay.com/misc/sounds/beep-07a.wav',
                    artwork: 'https://via.placeholder.com/100x100/48dbfb/ffffff?text=🎶',
                    source: 'Free Music'
                }
            ];
            
            return mockTracks;
        }

        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">😔 No results found. Try a different search term.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            results.forEach(track => {
                const item = document.createElement('div');
                item.className = 'search-item';
                item.onclick = () => playTrack(track);
                
                const duration = track.duration ? formatDuration(track.duration) : '';
                
                item.innerHTML = `
                    <img src="${track.artwork || 'https://via.placeholder.com/50x50/667eea/ffffff?text=🎵'}" 
                         alt="${track.title}" onerror="this.src='https://via.placeholder.com/50x50/667eea/ffffff?text=🎵'">
                    <div class="search-item-info">
                        <div class="search-item-title">${track.title}</div>
                        <div class="search-item-artist">${track.artist}</div>
                        <div class="search-item-duration">${track.source} • ${duration}</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // Format duration from seconds to mm:ss
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Play selected track
        function playTrack(track) {
            if (!track.preview_url) {
                updateStatus('❌ No preview available for this track');
                return;
            }
            
            // Hide YouTube player, show audio player
            document.getElementById('youtubePlayerContainer').style.display = 'none';
            document.getElementById('audioPlayerContainer').style.display = 'block';
            
            currentTrackType = 'audio';
            
            // Update audio player
            audioPlayer.src = track.preview_url;
            document.getElementById('audioTrackTitle').textContent = `🎵 ${track.title} - ${track.artist}`;
            
            // Update current song display
            updateCurrentSong(`${track.title} - ${track.artist}`);
            
            // Emit to other users (mock)
            socket.emit('audio-change', track);
            
            updateStatus(`🎵 Loaded: ${track.title}`);
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Join room function
        function joinRoom() {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            const roomIdInput = document.getElementById('roomIdInput').value.trim();

            if (!usernameInput) {
                updateSetupStatus('❌ Please enter your name');
                return;
            }

            username = usernameInput;
            currentRoomId = roomIdInput || generateRoomId();

            socket.emit('join-room', currentRoomId, username);

            document.getElementById('roomSetup').style.display = 'none';
            document.getElementById('playerSection').classList.add('active');
            document.getElementById('currentRoomId').textContent = currentRoomId;
            updateStatus(`✅ Joined room: ${currentRoomId}`);
            addChatMessage('System', `Welcome to room ${currentRoomId}!`);
        }

        // Generate random room ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Extract video ID from YouTube URL
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Load video function
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value.trim();
            if (!url) {
                updateStatus('❌ Please enter a YouTube URL');
                return;
            }

            const videoId = extractVideoId(url);
            if (!videoId) {
                updateStatus('❌ Invalid YouTube URL');
                return;
            }

            // Hide audio player, show YouTube player
            document.getElementById('audioPlayerContainer').style.display = 'none';
            document.getElementById('youtubePlayerContainer').style.display = 'block';
            
            currentTrackType = 'youtube';

            // Create video data
            const videoTitle = `🎵 Video ${videoId.substring(0, 8)}...`;
            const videoData = {
                videoId: videoId,
                title: videoTitle,
                url: url
            };

            socket.emit('video-change', videoData);
            createPlayer(videoId);
            updateCurrentSong(videoTitle);
            updateStatus('🎬 Video loaded successfully!');

            document.getElementById('youtubeUrl').value = '';
        }

        // Create YouTube player with better API handling
        function createPlayer(videoId) {
            const playerContainer = document.getElementById('youtubePlayerContainer');
            playerContainer.innerHTML = `<div id="youtube-player-div"></div>`;

            // Wait for YouTube API to be ready
            const initPlayer = () => {
                if (!window.YT || !window.YT.Player) {
                    setTimeout(initPlayer, 100);
                    return;
                }

                try {
                    player = new YT.Player('youtube-player-div', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: {
                            'playsinline': 1,
                            'controls': 1,
                            'rel': 0,
                            'modestbranding': 1,
                            'enablejsapi': 1,
                            'origin': window.location.origin
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                } catch (error) {
                    console.error('Failed to create YouTube player:', error);
                    updateStatus('❌ Failed to load video player');
                }
            };

            initPlayer();
        }

        // Player ready callback with better error handling
        function onPlayerReady(event) {
            console.log('✅ YouTube Player ready');
            isPlayerReady = true;
            updateStatus('🎵 Player ready!');
            
            // Set quality to auto for better performance
            try {
                player.setPlaybackQuality('default');
            } catch (e) {
                console.warn('Could not set playback quality:', e);
            }
        }

        // Player error callback
        function onPlayerError(event) {
            console.error('YouTube Player error:', event.data);
            updateStatus('❌ Video playback error');
            isPlayerReady = false;
        }

        // Enhanced player state change with better sync
        function onPlayerStateChange(event) {
            if (isUpdatingFromRemote) return;

            console.log('🎵 Player state changed:', event.data);
            
            try {
                const currentTime = player.getCurrentTime() || 0;
                
                if (event.data === YT.PlayerState.PLAYING) {
                    socket.emit('play-pause', {
                        isPlaying: true,
                        currentTime: currentTime,
                        mediaType: 'youtube'
                    });
                    updatePlayPauseButton(true);
                    updateStatus('▶️ Playing...');
                } else if (event.data === YT.PlayerState.PAUSED) {
                    socket.emit('play-pause', {
                        isPlaying: false,
                        currentTime: currentTime,
                        mediaType: 'youtube'
                    });
                    updatePlayPauseButton(false);
                    updateStatus('⏸️ Paused');
                } else if (event.data === YT.PlayerState.BUFFERING) {
                    updateStatus('⏳ Buffering...');
                } else if (event.data === YT.PlayerState.ENDED) {
                    updateStatus('✅ Video ended');
                    updatePlayPauseButton(false);
                }
            } catch (error) {
                console.error('Error in state change handler:', error);
            }
        }

        // Enhanced play/pause function with better error handling
        function playPause() {
            if (currentTrackType === 'youtube') {
                if (!player || !isPlayerReady) {
                    updateStatus('❌ No video loaded or player not ready');
                    return;
                }

                try {
                    const state = player.getPlayerState();
                    
                    if (state === YT.PlayerState.PLAYING) {
                        player.pauseVideo();
                    } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
                        player.playVideo();
                    } else {
                        updateStatus('⏳ Player not ready, please wait...');
                    }
                } catch (error) {
                    console.error('YouTube player error:', error);
                    updateStatus('❌ Player error');
                }
            } else if (currentTrackType === 'audio') {
                if (!audioPlayer.src) {
                    updateStatus('❌ No audio track loaded');
                    return;
                }

                try {
                    if (audioPlayer.paused) {
                        const playPromise = audioPlayer.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.error('Audio play failed:', error);
                                updateStatus('❌ Audio play failed - user interaction may be required');
                            });
                        }
                    } else {
                        audioPlayer.pause();
                    }
                } catch (error) {
                    console.error('Audio player error:', error);
                    updateStatus('❌ Audio player error');
                }
            } else {
                updateStatus('❌ No media loaded');
            }
        }

        // Enhanced sync request with better timing
        function syncRequest() {
            if (!socket.connected) {
                updateStatus('❌ Not connected to server');
                return;
            }
            
            socket.emit('sync-request');
            updateStatus('🔄 Requesting sync...');
            
            // Auto-sync every 30 seconds for better synchronization
            clearTimeout(window.autoSyncTimer);
            window.autoSyncTimer = setTimeout(() => {
                if (socket.connected && (currentTrackType === 'youtube' || currentTrackType === 'audio')) {
                    syncRequest();
                }
            }, 30000);
        }

        // Load video function with better error handling
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value.trim();
            if (!url) {
                updateStatus('❌ Please enter a YouTube URL');
                return;
            }

            const videoId = extractVideoId(url);
            if (!videoId) {
                updateStatus('❌ Invalid YouTube URL');
                return;
            }

            // Hide audio player, show YouTube player
            document.getElementById('audioPlayerContainer').style.display = 'none';
            document.getElementById('youtubePlayerContainer').style.display = 'block';
            
            currentTrackType = 'youtube';
            isPlayerReady = false;

            // Create video data
            const videoTitle = `🎵 YouTube Video`;
            const videoData = {
                videoId: videoId,
                title: videoTitle,
                url: url
            };

            socket.emit('video-change', videoData);
            createPlayer(videoId);
            updateCurrentSong(videoTitle);
            updateStatus('🎬 Loading video...');

            document.getElementById('youtubeUrl').value = '';
        }

        // Send chat message
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add message locally for demo
            addChatMessage(username || 'You', message);
            socket.emit('chat-message', message);
            input.value = '';
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = '🟢 Connected';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = '🔴 Disconnected';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // Update play/pause button
        function updatePlayPauseButton(isPlaying) {
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '⏸️ Pause' : '▶️ Play';
        }

        // Update status
        function updateStatus(message) {
            document.getElementById('playerStatus').textContent = message;
            console.log('📢 Status:', message);
        }

        // Update setup status
        function updateSetupStatus(message) {
            document.getElementById('setupStatus').textContent = message;
        }

        // Update current song display
        function updateCurrentSong(title) {
            document.getElementById('currentSong').innerHTML = `
                <h3>🎵 Now Playing</h3>
                <p>${title}</p>
            `;
        }

        // Update users list
        function updateUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            userList.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'user-item';
                userEl.innerHTML = `
                    <span>👤</span>
                    <span>${user.username}</span>
                `;
                container.appendChild(userEl);
            });
        }

        // Add chat message
        function addChatMessage(username, message) {
            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageEl.innerHTML = `
                <span class="username">${username}:</span>
                <span>${message}</span>
                <small style="opacity: 0.7; float: right;">${time}</small>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 50 messages
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // Handle enter key presses
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (e.target.id === 'usernameInput' || e.target.id === 'roomIdInput') {
                    joinRoom();
                } else if (e.target.id === 'youtubeUrl') {
                    loadVideo();
                } else if (e.target.id === 'chatInput') {
                    sendMessage();
                } else if (e.target.id === 'searchQuery') {
                    searchMusic();
                }
            }
        });

        // Handle window beforeunload
        window.addEventListener('beforeunload', () => {
            if (socket && socket.disconnect) {
                socket.disconnect();
            }
        });

        // Demo functionality - add some sample search results on load
        setTimeout(() => {
            // Demo functionality - add some sample search results including JioSaavn
            const sampleResults = [
                {
                    id: 'demo_1',
                    title: 'Chill Vibes',
                    artist: 'Lo-Fi Beats',
                    album: 'Study Session',
                    duration: 210,
                    preview_url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    artwork: 'https://via.placeholder.com/100x100/667eea/ffffff?text=🎵',
                    source: 'Free Music'
                },
                {
                    id: 'demo_2',
                    title: 'Sunset Dreams',
                    artist: 'Ambient Sounds',
                    album: 'Nature Collection',
                    duration: 185,
                    preview_url: 'https://www.soundjay.com/misc/sounds/beep-07a.wav',
                    artwork: 'https://via.placeholder.com/100x100/ff9ff3/ffffff?text=🌅',
                    source: 'Free Music'
                },
                {
                    id: 'jiosaavn_demo',
                    title: 'Tum Hi Ho',
                    artist: 'Arijit Singh',
                    album: 'Aashiqui 2',
                    duration: 262,
                    preview_url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    artwork: 'https://via.placeholder.com/100x100/ff6b6b/ffffff?text=🎵',
                    source: 'JioSaavn'
                },
                {
                    id: 'jiosaavn_demo2',
                    title: 'Raabta',
                    artist: 'Arijit Singh',
                    album: 'Agent Vinod',
                    duration: 245,
                    preview_url: 'https://www.soundjay.com/misc/sounds/beep-07a.wav',
                    artwork: 'https://via.placeholder.com/100x100/48dbfb/ffffff?text=🎶',
                    source: 'JioSaavn'
                }
            ];
            
            // Show sample results when page loads (for demo)
            document.getElementById('searchResults').innerHTML = `
                <div style="text-align: center; margin-bottom: 15px; opacity: 0.8;">
                    <small>🎵 Featured tracks from multiple sources (demo):</small>
                </div>
            `;
            displaySearchResults(sampleResults);
        }, 2000);
    </script>
</body>
</html>
